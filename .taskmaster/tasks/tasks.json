{
  "master": {
    "tasks": [
      {
        "id": 1,
        "title": "Project Foundation and Infrastructure Setup",
        "description": "Set up the complete development environment including Docker Compose for Elasticsearch 9.3.0, FastAPI backend project structure, and React+Vite+TypeScript frontend scaffold with Tailwind CSS configuration.",
        "details": "1. Create `docker-compose.yml` with Elasticsearch 9.3.0 service:\n   ```yaml\n   version: '3.8'\n   services:\n     elasticsearch:\n       image: docker.elastic.co/elasticsearch/elasticsearch:9.3.0\n       container_name: clinical-trials-es\n       environment:\n         - discovery.type=single-node\n         - xpack.security.enabled=false\n         - ES_JAVA_OPTS=-Xms512m -Xmx512m\n       ports:\n         - \"9200:9200\"\n       volumes:\n         - esdata:/usr/share/elasticsearch/data\n   volumes:\n     esdata:\n   ```\n\n2. Create backend structure:\n   ```\n   backend/\n   ├── app/\n   │   ├── __init__.py\n   │   ├── main.py           # FastAPI app entry\n   │   ├── config.py         # Pydantic Settings\n   │   ├── routers/\n   │   │   ├── __init__.py\n   │   │   └── search.py\n   │   ├── services/\n   │   │   ├── __init__.py\n   │   │   ├── llm_service.py\n   │   │   ├── es_service.py\n   │   │   └── suggestion.py\n   │   ├── models/\n   │   │   ├── __init__.py\n   │   │   ├── schemas.py\n   │   │   └── entities.py\n   │   └── utils/\n   │       ├── __init__.py\n   │       └── synonyms.py\n   ├── scripts/\n   │   ├── ingest.py\n   │   └── create_index.py\n   └── requirements.txt\n   ```\n\n3. Create `backend/requirements.txt`:\n   ```\n   fastapi==0.115.12\n   uvicorn[standard]==0.34.0\n   elasticsearch==9.0.1\n   anthropic==0.52.0\n   pydantic==2.11.4\n   pydantic-settings==2.8.1\n   python-dotenv==1.1.0\n   httpx==0.28.1\n   ```\n\n4. Create `backend/app/config.py` with Pydantic Settings:\n   ```python\n   from pydantic_settings import BaseSettings\n   from functools import lru_cache\n\n   class Settings(BaseSettings):\n       es_url: str = \"http://localhost:9200\"\n       es_index: str = \"clinical_trials\"\n       anthropic_api_key: str\n       log_level: str = \"INFO\"\n\n       class Config:\n           env_file = \".env\"\n\n   @lru_cache()\n   def get_settings() -> Settings:\n       return Settings()\n   ```\n\n5. Initialize frontend with Vite + React + TypeScript:\n   ```bash\n   npm create vite@latest frontend -- --template react-ts\n   cd frontend && npm install\n   npm install -D tailwindcss@4.0.5 @tailwindcss/vite\n   ```\n\n6. Configure Tailwind CSS in `frontend/vite.config.ts`:\n   ```typescript\n   import { defineConfig } from 'vite'\n   import react from '@vitejs/plugin-react'\n   import tailwindcss from '@tailwindcss/vite'\n\n   export default defineConfig({\n     plugins: [react(), tailwindcss()],\n   })\n   ```\n\n7. Set up custom theme in `frontend/src/index.css` with CSS variables:\n   - Primary: #0D4F4F (deep teal)\n   - Accent: #D4A843 (warm amber)\n   - Background: #F8F6F3\n   - Status colors for badges\n   - Import Google Fonts (Fraunces for display, Outfit for body)\n\n8. Create `.env` file at project root with required API keys.",
        "testStrategy": "1. Verify Docker Compose starts Elasticsearch: `docker-compose up -d && curl http://localhost:9200`\n2. Verify backend dependencies install: `cd backend && pip install -r requirements.txt`\n3. Verify frontend builds: `cd frontend && npm run dev`\n4. Check Tailwind CSS compiles with custom theme\n5. Verify config.py loads environment variables correctly",
        "priority": "high",
        "dependencies": [],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 2,
        "title": "Pydantic Data Models and Type Definitions",
        "description": "Define comprehensive Pydantic models for entity extraction, API request/response schemas, and corresponding TypeScript interfaces for the frontend.",
        "details": "1. Create `backend/app/models/entities.py`:\n   ```python\n   from pydantic import BaseModel, Field\n   from typing import Optional, List\n   from enum import Enum\n\n   class PhaseEnum(str, Enum):\n       PHASE1 = \"PHASE1\"\n       PHASE2 = \"PHASE2\"\n       PHASE3 = \"PHASE3\"\n       PHASE4 = \"PHASE4\"\n       EARLY_PHASE1 = \"EARLY_PHASE1\"\n       NA = \"NA\"\n\n   class StatusEnum(str, Enum):\n       RECRUITING = \"RECRUITING\"\n       NOT_YET_RECRUITING = \"NOT_YET_RECRUITING\"\n       COMPLETED = \"COMPLETED\"\n       ACTIVE_NOT_RECRUITING = \"ACTIVE_NOT_RECRUITING\"\n       TERMINATED = \"TERMINATED\"\n       WITHDRAWN = \"WITHDRAWN\"\n       SUSPENDED = \"SUSPENDED\"\n\n   class LocationFilter(BaseModel):\n       city: Optional[str] = None\n       state: Optional[str] = None\n       country: Optional[str] = None\n\n   class ExtractedEntities(BaseModel):\n       phase: Optional[str] = Field(None, description=\"Clinical trial phase\")\n       condition: Optional[str] = Field(None, description=\"Medical condition/disease\")\n       status: Optional[str] = Field(None, description=\"Trial recruitment status\")\n       location: Optional[LocationFilter] = Field(None, description=\"Geographic location\")\n       sponsor: Optional[str] = Field(None, description=\"Sponsoring organization\")\n       keyword: Optional[str] = Field(None, description=\"Gene, drug, or specific term\")\n       age_group: Optional[str] = Field(None, description=\"Target age group\")\n       enrollment_min: Optional[int] = Field(None, description=\"Minimum enrollment\")\n       enrollment_max: Optional[int] = Field(None, description=\"Maximum enrollment\")\n       confidence: float = Field(default=0.8, ge=0.0, le=1.0)\n       clarification: Optional[str] = Field(None, description=\"Follow-up question\")\n   ```\n\n2. Create `backend/app/models/schemas.py`:\n   ```python\n   from pydantic import BaseModel\n   from typing import List, Optional, Any, Dict\n   from .entities import ExtractedEntities\n\n   class Sponsor(BaseModel):\n       name: str\n       agency_class: Optional[str] = None\n       lead_or_collaborator: Optional[str] = None\n\n   class Facility(BaseModel):\n       name: Optional[str] = None\n       city: Optional[str] = None\n       state: Optional[str] = None\n       country: Optional[str] = None\n\n   class TrialResult(BaseModel):\n       nct_id: str\n       brief_title: str\n       official_title: Optional[str] = None\n       phase: Optional[str] = None\n       overall_status: Optional[str] = None\n       enrollment: Optional[int] = None\n       sponsors: List[Sponsor] = []\n       facilities: List[Facility] = []\n       brief_summaries_description: Optional[str] = None\n       start_date: Optional[str] = None\n       age: List[Dict[str, str]] = []\n\n   class SearchResponse(BaseModel):\n       query_interpretation: ExtractedEntities\n       results: List[TrialResult]\n       total: int\n       page: int\n       page_size: int\n       clarification: Optional[str] = None\n\n   class SuggestionResponse(BaseModel):\n       suggestions: List[str]\n\n   class ErrorResponse(BaseModel):\n       error: str\n       detail: str\n   ```\n\n3. Create `frontend/src/types/index.ts`:\n   ```typescript\n   export interface LocationFilter {\n     city?: string;\n     state?: string;\n     country?: string;\n   }\n\n   export interface ExtractedEntities {\n     phase?: string;\n     condition?: string;\n     status?: string;\n     location?: LocationFilter;\n     sponsor?: string;\n     keyword?: string;\n     age_group?: string;\n     enrollment_min?: number;\n     enrollment_max?: number;\n     confidence: number;\n     clarification?: string;\n   }\n\n   export interface Sponsor {\n     name: string;\n     agency_class?: string;\n     lead_or_collaborator?: string;\n   }\n\n   export interface Facility {\n     name?: string;\n     city?: string;\n     state?: string;\n     country?: string;\n   }\n\n   export interface TrialResult {\n     nct_id: string;\n     brief_title: string;\n     official_title?: string;\n     phase?: string;\n     overall_status?: string;\n     enrollment?: number;\n     sponsors: Sponsor[];\n     facilities: Facility[];\n     brief_summaries_description?: string;\n     start_date?: string;\n     age: { age_category: string }[];\n   }\n\n   export interface SearchResponse {\n     query_interpretation: ExtractedEntities;\n     results: TrialResult[];\n     total: number;\n     page: number;\n     page_size: number;\n     clarification?: string;\n   }\n\n   export interface SuggestionResponse {\n     suggestions: string[];\n   }\n   ```",
        "testStrategy": "1. Unit test Pydantic model validation with sample data from clinical_trials.json\n2. Test optional field handling with partial data\n3. Test enum validation for phase and status fields\n4. Verify TypeScript types compile without errors\n5. Test round-trip serialization/deserialization",
        "priority": "high",
        "dependencies": [
          1
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 3,
        "title": "Elasticsearch Index Mapping and Bulk Ingestion",
        "description": "Create the Elasticsearch index with optimized field mappings for clinical trials data and implement bulk indexing script to load all 1000 documents.",
        "details": "1. Create `backend/scripts/create_index.py`:\n   ```python\n   from elasticsearch import Elasticsearch\n   import sys\n   sys.path.append('..')\n   from app.config import get_settings\n\n   def create_index():\n       settings = get_settings()\n       es = Elasticsearch([settings.es_url])\n       \n       mapping = {\n           \"settings\": {\n               \"number_of_shards\": 1,\n               \"number_of_replicas\": 0,\n               \"analysis\": {\n                   \"analyzer\": {\n                       \"clinical_analyzer\": {\n                           \"type\": \"custom\",\n                           \"tokenizer\": \"standard\",\n                           \"filter\": [\"lowercase\", \"asciifolding\"]\n                       }\n                   }\n               }\n           },\n           \"mappings\": {\n               \"properties\": {\n                   \"nct_id\": {\"type\": \"keyword\"},\n                   \"brief_title\": {\n                       \"type\": \"text\",\n                       \"analyzer\": \"clinical_analyzer\",\n                       \"fields\": {\n                           \"suggest\": {\"type\": \"search_as_you_type\"}\n                       }\n                   },\n                   \"official_title\": {\n                       \"type\": \"text\",\n                       \"analyzer\": \"clinical_analyzer\",\n                       \"fields\": {\n                           \"suggest\": {\"type\": \"search_as_you_type\"}\n                       }\n                   },\n                   \"phase\": {\"type\": \"keyword\"},\n                   \"overall_status\": {\"type\": \"keyword\"},\n                   \"enrollment\": {\"type\": \"integer\"},\n                   \"gender\": {\"type\": \"keyword\"},\n                   \"study_type\": {\"type\": \"keyword\"},\n                   \"intervention_model\": {\"type\": \"keyword\"},\n                   \"primary_purpose\": {\"type\": \"keyword\"},\n                   \"start_date\": {\"type\": \"date\"},\n                   \"completion_date\": {\"type\": \"date\"},\n                   \"primary_completion_date\": {\"type\": \"date\"},\n                   \"age\": {\n                       \"type\": \"nested\",\n                       \"properties\": {\n                           \"age_category\": {\"type\": \"keyword\"}\n                       }\n                   },\n                   \"sponsors\": {\n                       \"type\": \"nested\",\n                       \"properties\": {\n                           \"name\": {\n                               \"type\": \"text\",\n                               \"fields\": {\"keyword\": {\"type\": \"keyword\"}}\n                           },\n                           \"agency_class\": {\"type\": \"keyword\"},\n                           \"lead_or_collaborator\": {\"type\": \"keyword\"}\n                       }\n                   },\n                   \"facilities\": {\n                       \"type\": \"nested\",\n                       \"properties\": {\n                           \"name\": {\"type\": \"text\"},\n                           \"city\": {\"type\": \"keyword\"},\n                           \"state\": {\"type\": \"keyword\"},\n                           \"country\": {\"type\": \"keyword\"}\n                       }\n                   },\n                   \"design_outcomes\": {\n                       \"type\": \"nested\",\n                       \"properties\": {\n                           \"outcome_type\": {\"type\": \"keyword\"},\n                           \"measure\": {\"type\": \"text\"},\n                           \"time_frame\": {\"type\": \"text\"},\n                           \"description\": {\"type\": \"text\"}\n                       }\n                   },\n                   \"brief_summaries_description\": {\"type\": \"text\", \"analyzer\": \"clinical_analyzer\"},\n                   \"detailed_description\": {\"type\": \"text\", \"analyzer\": \"clinical_analyzer\"},\n                   \"source\": {\"type\": \"keyword\"},\n                   \"acronym\": {\"type\": \"keyword\"}\n               }\n           }\n       }\n       \n       if es.indices.exists(index=settings.es_index):\n           es.indices.delete(index=settings.es_index)\n       \n       es.indices.create(index=settings.es_index, body=mapping)\n       print(f\"Index '{settings.es_index}' created successfully\")\n\n   if __name__ == \"__main__\":\n       create_index()\n   ```\n\n2. Create `backend/scripts/ingest.py`:\n   ```python\n   import json\n   from elasticsearch import Elasticsearch\n   from elasticsearch.helpers import bulk\n   import sys\n   sys.path.append('..')\n   from app.config import get_settings\n\n   def transform_document(doc):\n       \"\"\"Transform document for ES indexing\"\"\"\n       # Convert enrollment from string to int\n       if doc.get('enrollment'):\n           try:\n               doc['enrollment'] = int(doc['enrollment'])\n           except (ValueError, TypeError):\n               doc['enrollment'] = None\n       \n       # Ensure nested arrays are properly structured\n       doc['sponsors'] = doc.get('sponsors') or []\n       doc['facilities'] = doc.get('facilities') or []\n       doc['design_outcomes'] = doc.get('design_outcomes') or []\n       doc['age'] = doc.get('age') or []\n       \n       return doc\n\n   def generate_bulk_actions(data, index_name):\n       for doc in data:\n           transformed = transform_document(doc)\n           yield {\n               \"_index\": index_name,\n               \"_id\": doc['nct_id'],\n               \"_source\": transformed\n           }\n\n   def ingest_data(filepath):\n       settings = get_settings()\n       es = Elasticsearch([settings.es_url])\n       \n       with open(filepath, 'r') as f:\n           data = json.load(f)\n       \n       success, failed = bulk(es, generate_bulk_actions(data, settings.es_index))\n       print(f\"Indexed {success} documents, {len(failed)} failed\")\n       \n       # Refresh index for immediate searchability\n       es.indices.refresh(index=settings.es_index)\n\n   if __name__ == \"__main__\":\n       ingest_data('../../clinical_trials.json')\n   ```",
        "testStrategy": "1. Verify index creation: `curl -X GET 'localhost:9200/clinical_trials/_mapping?pretty'`\n2. Run ingestion and verify count: `curl -X GET 'localhost:9200/clinical_trials/_count'` should return 1000\n3. Test sample queries:\n   - `curl -X GET 'localhost:9200/clinical_trials/_search?q=phase:PHASE2'`\n   - Nested query for facilities by country\n   - Range query on enrollment\n4. Verify search_as_you_type works with prefix queries\n5. Test enrollment type conversion with edge cases",
        "priority": "high",
        "dependencies": [
          1
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 4,
        "title": "Claude API LLM Service for Entity Extraction",
        "description": "Implement the LLM service using Claude API (anthropic SDK) to extract structured entities from natural language queries, including domain synonym handling and clarification detection.",
        "details": "1. Create `backend/app/services/llm_service.py`:\n   ```python\n   import anthropic\n   import json\n   from typing import Optional\n   from ..config import get_settings\n   from ..models.entities import ExtractedEntities, LocationFilter\n\n   SYSTEM_PROMPT = '''You are a clinical trials search assistant. Extract structured filters from natural language queries about clinical trials.\n\n   Available fields to extract:\n   - phase: One of PHASE1, PHASE2, PHASE3, PHASE4, EARLY_PHASE1, NA\n   - condition: The medical condition or disease (e.g., \"Breast Cancer\", \"Diabetes\", \"Asthma\")\n   - status: One of RECRUITING, NOT_YET_RECRUITING, COMPLETED, ACTIVE_NOT_RECRUITING, TERMINATED, WITHDRAWN, SUSPENDED\n   - location: Object with city, state, and/or country fields\n   - sponsor: Organization name (e.g., \"AstraZeneca\", \"Pfizer\")\n   - keyword: Specific terms like gene names (BRCA1, EGFR), drug names, or technical terms\n   - age_group: One of \"adult\", \"child\", \"older-adults\"\n   - enrollment_min: Minimum number of participants\n   - enrollment_max: Maximum number of participants\n\n   Domain synonym mappings (translate these automatically):\n   - \"open\", \"recruiting\", \"active\", \"enrolling\" -> status: RECRUITING\n   - \"closed\", \"finished\", \"completed\", \"done\" -> status: COMPLETED\n   - \"upcoming\", \"not started\", \"planned\" -> status: NOT_YET_RECRUITING\n   - \"running\", \"ongoing\" -> status: RECRUITING or ACTIVE_NOT_RECRUITING\n   - \"phase 1\", \"phase I\", \"P1\" -> phase: PHASE1\n   - \"phase 2\", \"phase II\", \"P2\" -> phase: PHASE2\n   - \"phase 3\", \"phase III\", \"P3\" -> phase: PHASE3\n   - \"phase 4\", \"phase IV\", \"P4\" -> phase: PHASE4\n   - \"USA\", \"US\", \"United States\", \"America\" -> location.country: \"United States\"\n   - \"large trials\", \"big studies\" -> enrollment_min: 500\n\n   Output JSON format:\n   {\n     \"phase\": \"PHASE2\" or null,\n     \"condition\": \"disease name\" or null,\n     \"status\": \"RECRUITING\" or null,\n     \"location\": {\"city\": \"\", \"state\": \"\", \"country\": \"\"} or null,\n     \"sponsor\": \"company name\" or null,\n     \"keyword\": \"gene/drug name\" or null,\n     \"age_group\": \"adult\" or null,\n     \"enrollment_min\": 500 or null,\n     \"enrollment_max\": null,\n     \"confidence\": 0.0-1.0,\n     \"clarification\": \"question to ask user\" or null\n   }\n\n   Rules:\n   1. Only extract entities that are clearly stated or strongly implied\n   2. Set confidence based on how clear the query is (1.0 = very clear, 0.5 = ambiguous)\n   3. If the query is ambiguous, misspelled, or too broad, set clarification with a helpful question\n   4. Return null for fields not mentioned in the query\n   5. Always respond with valid JSON only, no explanations'''\n\n   async def extract_entities(query: str) -> ExtractedEntities:\n       \"\"\"Extract structured entities from natural language query using Claude API\"\"\"\n       settings = get_settings()\n       client = anthropic.Anthropic(api_key=settings.anthropic_api_key)\n       \n       try:\n           message = client.messages.create(\n               model=\"claude-sonnet-4-20250514\",\n               max_tokens=1024,\n               system=SYSTEM_PROMPT,\n               messages=[\n                   {\"role\": \"user\", \"content\": f\"Extract entities from this clinical trials search query: \\\"{query}\\\"\"}\n               ]\n           )\n           \n           response_text = message.content[0].text\n           # Parse JSON response\n           data = json.loads(response_text)\n           \n           # Convert location dict to LocationFilter if present\n           if data.get('location'):\n               data['location'] = LocationFilter(**data['location'])\n           \n           return ExtractedEntities(**data)\n           \n       except json.JSONDecodeError:\n           # Fallback if LLM returns invalid JSON\n           return ExtractedEntities(\n               confidence=0.3,\n               clarification=\"I had trouble understanding your query. Could you rephrase it?\"\n           )\n       except Exception as e:\n           return ExtractedEntities(\n               confidence=0.0,\n               clarification=f\"An error occurred. Please try again.\"\n           )\n   ```\n\n2. Add domain constants in `backend/app/utils/synonyms.py` for reference (used in prompt):\n   ```python\n   STATUS_SYNONYMS = {\n       \"open\": \"RECRUITING\",\n       \"recruiting\": \"RECRUITING\",\n       \"closed\": \"COMPLETED\",\n       \"finished\": \"COMPLETED\",\n       \"upcoming\": \"NOT_YET_RECRUITING\",\n       \"running\": \"RECRUITING\",\n   }\n\n   PHASE_MAPPINGS = {\n       \"phase 1\": \"PHASE1\",\n       \"phase i\": \"PHASE1\",\n       \"phase 2\": \"PHASE2\",\n       \"phase ii\": \"PHASE2\",\n       \"phase 3\": \"PHASE3\",\n       \"phase iii\": \"PHASE3\",\n       \"phase 4\": \"PHASE4\",\n       \"phase iv\": \"PHASE4\",\n   }\n   ```",
        "testStrategy": "1. Test with various query types:\n   - \"Phase 3 lung cancer trials in the USA\" -> should extract phase=PHASE3, condition=lung cancer, location.country=United States\n   - \"recruiting diabetes trials\" -> status=RECRUITING, condition=diabetes\n   - \"open melanoma trials\" -> status=RECRUITING (synonym), condition=melanoma\n   - \"List all Phase 2 trials for Breast Cancer associated with BRCA1\" -> phase=PHASE2, condition=Breast Cancer, keyword=BRCA1\n2. Test confidence scoring with clear vs ambiguous queries\n3. Test clarification generation for misspelled conditions\n4. Test edge cases: empty query, gibberish input, only stop words\n5. Verify JSON parsing error handling",
        "priority": "high",
        "dependencies": [
          2
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 5,
        "title": "Elasticsearch Query Builder Service",
        "description": "Implement the service that converts extracted entities into optimized Elasticsearch Query DSL with proper handling of nested fields, term queries, and multi-match searches.",
        "details": "1. Create `backend/app/services/es_service.py`:\n   ```python\n   from elasticsearch import Elasticsearch\n   from typing import Optional, Dict, Any, List\n   from ..config import get_settings\n   from ..models.entities import ExtractedEntities\n   from ..models.schemas import TrialResult, Sponsor, Facility\n\n   class ElasticsearchService:\n       def __init__(self):\n           settings = get_settings()\n           self.es = Elasticsearch([settings.es_url])\n           self.index = settings.es_index\n\n       def build_query(self, entities: ExtractedEntities) -> Dict[str, Any]:\n           \"\"\"Build Elasticsearch query DSL from extracted entities\"\"\"\n           must_clauses = []\n           filter_clauses = []\n           should_clauses = []\n\n           # Phase - exact match filter\n           if entities.phase:\n               filter_clauses.append({\"term\": {\"phase\": entities.phase}})\n\n           # Status - exact match filter\n           if entities.status:\n               filter_clauses.append({\"term\": {\"overall_status\": entities.status}})\n\n           # Condition - text match across title and description\n           if entities.condition:\n               must_clauses.append({\n                   \"multi_match\": {\n                       \"query\": entities.condition,\n                       \"fields\": [\"brief_title^3\", \"official_title^2\", \"brief_summaries_description\"],\n                       \"type\": \"best_fields\",\n                       \"fuzziness\": \"AUTO\"\n                   }\n               })\n\n           # Location - nested query on facilities\n           if entities.location:\n               location_filters = []\n               if entities.location.country:\n                   location_filters.append({\"term\": {\"facilities.country\": entities.location.country}})\n               if entities.location.state:\n                   location_filters.append({\"term\": {\"facilities.state\": entities.location.state}})\n               if entities.location.city:\n                   location_filters.append({\"term\": {\"facilities.city\": entities.location.city}})\n               \n               if location_filters:\n                   filter_clauses.append({\n                       \"nested\": {\n                           \"path\": \"facilities\",\n                           \"query\": {\"bool\": {\"must\": location_filters}}\n                       }\n                   })\n\n           # Sponsor - nested query\n           if entities.sponsor:\n               filter_clauses.append({\n                   \"nested\": {\n                       \"path\": \"sponsors\",\n                       \"query\": {\n                           \"match\": {\"sponsors.name\": entities.sponsor}\n                       }\n                   }\n               })\n\n           # Keyword/Gene - multi-match across all text fields\n           if entities.keyword:\n               must_clauses.append({\n                   \"multi_match\": {\n                       \"query\": entities.keyword,\n                       \"fields\": [\n                           \"brief_title^2\",\n                           \"official_title^2\",\n                           \"brief_summaries_description\",\n                           \"detailed_description\"\n                       ],\n                       \"type\": \"phrase_prefix\"\n                   }\n               })\n\n           # Age group - nested query on age array\n           if entities.age_group:\n               filter_clauses.append({\n                   \"nested\": {\n                       \"path\": \"age\",\n                       \"query\": {\"term\": {\"age.age_category\": entities.age_group}}\n                   }\n               })\n\n           # Enrollment range\n           if entities.enrollment_min or entities.enrollment_max:\n               range_query = {}\n               if entities.enrollment_min:\n                   range_query[\"gte\"] = entities.enrollment_min\n               if entities.enrollment_max:\n                   range_query[\"lte\"] = entities.enrollment_max\n               filter_clauses.append({\"range\": {\"enrollment\": range_query}})\n\n           # Build final query\n           query = {\"bool\": {}}\n           if must_clauses:\n               query[\"bool\"][\"must\"] = must_clauses\n           if filter_clauses:\n               query[\"bool\"][\"filter\"] = filter_clauses\n           if should_clauses:\n               query[\"bool\"][\"should\"] = should_clauses\n\n           # If no clauses, match all\n           if not must_clauses and not filter_clauses:\n               query = {\"match_all\": {}}\n\n           return query\n\n       async def search(self, entities: ExtractedEntities, page: int = 1, page_size: int = 10) -> tuple[List[TrialResult], int]:\n           \"\"\"Execute search and return results with total count\"\"\"\n           query = self.build_query(entities)\n           \n           response = self.es.search(\n               index=self.index,\n               body={\n                   \"query\": query,\n                   \"from\": (page - 1) * page_size,\n                   \"size\": page_size,\n                   \"sort\": [{\"_score\": \"desc\"}, {\"enrollment\": \"desc\"}],\n                   \"_source\": [\n                       \"nct_id\", \"brief_title\", \"official_title\", \"phase\",\n                       \"overall_status\", \"enrollment\", \"sponsors\", \"facilities\",\n                       \"brief_summaries_description\", \"start_date\", \"age\"\n                   ]\n               }\n           )\n           \n           results = []\n           for hit in response[\"hits\"][\"hits\"]:\n               source = hit[\"_source\"]\n               results.append(TrialResult(\n                   nct_id=source[\"nct_id\"],\n                   brief_title=source[\"brief_title\"],\n                   official_title=source.get(\"official_title\"),\n                   phase=source.get(\"phase\"),\n                   overall_status=source.get(\"overall_status\"),\n                   enrollment=source.get(\"enrollment\"),\n                   sponsors=[Sponsor(**s) for s in source.get(\"sponsors\", [])],\n                   facilities=[Facility(**f) for f in source.get(\"facilities\", [])[:3]],\n                   brief_summaries_description=source.get(\"brief_summaries_description\"),\n                   start_date=source.get(\"start_date\"),\n                   age=source.get(\"age\", [])\n               ))\n           \n           total = response[\"hits\"][\"total\"][\"value\"]\n           return results, total\n\n   es_service = ElasticsearchService()\n   ```",
        "testStrategy": "1. Unit test query building with mock entities:\n   - Phase only -> term filter\n   - Condition only -> multi_match\n   - Location with nested query\n   - Combined filters\n2. Integration test against live ES:\n   - Search for \"Phase 2 Asthma\" and verify relevant results\n   - Verify pagination works correctly\n   - Test enrollment range queries\n3. Verify nested query syntax for facilities, sponsors, and age\n4. Test empty entities returns match_all query\n5. Benchmark query performance on full dataset",
        "priority": "high",
        "dependencies": [
          3,
          4
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 6,
        "title": "Auto-Suggestion Service Implementation",
        "description": "Implement the suggestion service using Elasticsearch search_as_you_type fields to provide type-ahead suggestions as users type their queries.",
        "details": "1. Create `backend/app/services/suggestion.py`:\n   ```python\n   from elasticsearch import Elasticsearch\n   from typing import List\n   from ..config import get_settings\n\n   class SuggestionService:\n       def __init__(self):\n           settings = get_settings()\n           self.es = Elasticsearch([settings.es_url])\n           self.index = settings.es_index\n\n       async def get_suggestions(self, prefix: str, limit: int = 10) -> List[str]:\n           \"\"\"Get type-ahead suggestions using search_as_you_type\"\"\"\n           if not prefix or len(prefix) < 2:\n               return []\n\n           response = self.es.search(\n               index=self.index,\n               body={\n                   \"size\": 0,\n                   \"query\": {\n                       \"bool\": {\n                           \"should\": [\n                               {\n                                   \"multi_match\": {\n                                       \"query\": prefix,\n                                       \"type\": \"bool_prefix\",\n                                       \"fields\": [\n                                           \"brief_title.suggest\",\n                                           \"brief_title.suggest._2gram\",\n                                           \"brief_title.suggest._3gram\"\n                                       ]\n                                   }\n                               }\n                           ]\n                       }\n                   },\n                   \"aggs\": {\n                       \"unique_conditions\": {\n                           \"terms\": {\n                               \"field\": \"phase\",\n                               \"size\": 5\n                           }\n                       },\n                       \"title_suggestions\": {\n                           \"significant_text\": {\n                               \"field\": \"brief_title\",\n                               \"filter_duplicate_text\": True,\n                               \"size\": limit\n                           }\n                       }\n                   }\n               }\n           )\n\n           # Extract suggestions from aggregations\n           suggestions = []\n           \n           # Get significant terms from titles\n           if \"aggregations\" in response:\n               sig_terms = response[\"aggregations\"].get(\"title_suggestions\", {}).get(\"buckets\", [])\n               for bucket in sig_terms:\n                   suggestions.append(bucket[\"key\"])\n\n           # Fallback: simple prefix search on titles\n           if not suggestions:\n               prefix_response = self.es.search(\n                   index=self.index,\n                   body={\n                       \"size\": limit,\n                       \"query\": {\n                           \"multi_match\": {\n                               \"query\": prefix,\n                               \"type\": \"phrase_prefix\",\n                               \"fields\": [\"brief_title\", \"official_title\"]\n                           }\n                       },\n                       \"_source\": [\"brief_title\"]\n                   }\n               )\n               \n               seen = set()\n               for hit in prefix_response[\"hits\"][\"hits\"]:\n                   title = hit[\"_source\"].get(\"brief_title\", \"\")\n                   # Extract first few words as suggestion\n                   words = title.split()[:6]\n                   suggestion = \" \".join(words)\n                   if suggestion.lower() not in seen:\n                       seen.add(suggestion.lower())\n                       suggestions.append(suggestion)\n\n           return suggestions[:limit]\n\n   suggestion_service = SuggestionService()\n   ```\n\n2. Enhance for condition-specific suggestions:\n   ```python\n   async def get_condition_suggestions(self, prefix: str) -> List[str]:\n       \"\"\"Get common condition names matching prefix\"\"\"\n       # Pre-defined common conditions for fast suggestions\n       common_conditions = [\n           \"Breast Cancer\", \"Lung Cancer\", \"Diabetes\", \"Asthma\",\n           \"COVID-19\", \"Heart Disease\", \"Alzheimer's\", \"Melanoma\",\n           \"Leukemia\", \"Rheumatoid Arthritis\", \"Multiple Sclerosis\"\n       ]\n       \n       matching = [c for c in common_conditions \n                   if c.lower().startswith(prefix.lower())]\n       return matching[:5]\n   ```",
        "testStrategy": "1. Test with various prefixes: \"can\" -> Cancer suggestions, \"dia\" -> Diabetes\n2. Verify minimum character requirement (2 chars)\n3. Test response time is under 100ms for type-ahead UX\n4. Verify deduplication of similar suggestions\n5. Test empty prefix returns empty list\n6. Integration test with frontend debounced input",
        "priority": "medium",
        "dependencies": [
          3
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 7,
        "title": "FastAPI Search and Suggestion Endpoints",
        "description": "Implement the main FastAPI application with /search and /suggest endpoints, CORS configuration, error handling middleware, and proper dependency injection.",
        "details": "1. Create `backend/app/routers/search.py`:\n   ```python\n   from fastapi import APIRouter, Query, HTTPException\n   from typing import Optional\n   from ..services.llm_service import extract_entities\n   from ..services.es_service import es_service\n   from ..services.suggestion import suggestion_service\n   from ..models.schemas import SearchResponse, SuggestionResponse, ErrorResponse\n\n   router = APIRouter(prefix=\"/api\", tags=[\"search\"])\n\n   @router.get(\"/search/{query}\", response_model=SearchResponse)\n   async def search_trials(\n       query: str,\n       page: int = Query(default=1, ge=1),\n       page_size: int = Query(default=10, ge=1, le=100)\n   ):\n       \"\"\"Search clinical trials using natural language query\"\"\"\n       try:\n           # Extract entities using LLM\n           entities = await extract_entities(query)\n           \n           # Search Elasticsearch\n           results, total = await es_service.search(entities, page, page_size)\n           \n           return SearchResponse(\n               query_interpretation=entities,\n               results=results,\n               total=total,\n               page=page,\n               page_size=page_size,\n               clarification=entities.clarification\n           )\n       except Exception as e:\n           raise HTTPException(status_code=500, detail=str(e))\n\n   @router.get(\"/suggest\", response_model=SuggestionResponse)\n   async def get_suggestions(\n       q: str = Query(..., min_length=2, description=\"Partial query text\")\n   ):\n       \"\"\"Get type-ahead suggestions for partial query\"\"\"\n       try:\n           suggestions = await suggestion_service.get_suggestions(q)\n           return SuggestionResponse(suggestions=suggestions)\n       except Exception as e:\n           raise HTTPException(status_code=500, detail=str(e))\n   ```\n\n2. Create `backend/app/main.py`:\n   ```python\n   from fastapi import FastAPI, Request\n   from fastapi.middleware.cors import CORSMiddleware\n   from fastapi.responses import JSONResponse\n   from .routers import search\n   from .config import get_settings\n\n   app = FastAPI(\n       title=\"Clinical Trials Search API\",\n       description=\"Natural language search for clinical trials\",\n       version=\"1.0.0\"\n   )\n\n   # CORS middleware for frontend\n   app.add_middleware(\n       CORSMiddleware,\n       allow_origins=[\n           \"http://localhost:5173\",  # Vite dev server\n           \"http://localhost:3000\",\n           \"http://127.0.0.1:5173\"\n       ],\n       allow_credentials=True,\n       allow_methods=[\"*\"],\n       allow_headers=[\"*\"],\n   )\n\n   # Global exception handler\n   @app.exception_handler(Exception)\n   async def global_exception_handler(request: Request, exc: Exception):\n       return JSONResponse(\n           status_code=500,\n           content={\"error\": \"Internal server error\", \"detail\": str(exc)}\n       )\n\n   # Include routers\n   app.include_router(search.router)\n\n   @app.get(\"/health\")\n   async def health_check():\n       return {\"status\": \"healthy\"}\n\n   if __name__ == \"__main__\":\n       import uvicorn\n       uvicorn.run(app, host=\"0.0.0.0\", port=8000)\n   ```\n\n3. Verify OpenAPI documentation at /docs endpoint",
        "testStrategy": "1. Manual API testing with curl:\n   - `curl 'http://localhost:8000/api/search/Phase%203%20lung%20cancer'`\n   - `curl 'http://localhost:8000/api/suggest?q=can'`\n2. Test CORS headers are present in response\n3. Test pagination: page=2, page_size=5\n4. Test error handling with invalid queries\n5. Verify health endpoint returns 200\n6. Test OpenAPI docs at /docs\n7. Load test with multiple concurrent requests",
        "priority": "high",
        "dependencies": [
          4,
          5,
          6
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 8,
        "title": "Frontend API Client and Core Components",
        "description": "Implement the React frontend API client service and core UI components including SearchBar with debounced suggestions, QueryInterpretation display, and result card components.",
        "details": "1. Create `frontend/src/services/api.ts`:\n   ```typescript\n   import type { SearchResponse, SuggestionResponse } from '../types';\n\n   const API_BASE = 'http://localhost:8000/api';\n\n   export async function searchTrials(\n     query: string,\n     page: number = 1,\n     pageSize: number = 10\n   ): Promise<SearchResponse> {\n     const response = await fetch(\n       `${API_BASE}/search/${encodeURIComponent(query)}?page=${page}&page_size=${pageSize}`\n     );\n     if (!response.ok) {\n       throw new Error(`Search failed: ${response.statusText}`);\n     }\n     return response.json();\n   }\n\n   export async function getSuggestions(prefix: string): Promise<string[]> {\n     if (prefix.length < 2) return [];\n     const response = await fetch(\n       `${API_BASE}/suggest?q=${encodeURIComponent(prefix)}`\n     );\n     if (!response.ok) return [];\n     const data: SuggestionResponse = await response.json();\n     return data.suggestions;\n   }\n   ```\n\n2. Create `frontend/src/components/SearchBar.tsx`:\n   ```tsx\n   import { useState, useCallback, useRef, useEffect } from 'react';\n   import { getSuggestions } from '../services/api';\n\n   interface SearchBarProps {\n     onSearch: (query: string) => void;\n     isLoading: boolean;\n   }\n\n   const EXAMPLE_QUERIES = [\n     \"Phase 3 lung cancer trials in the USA\",\n     \"recruiting diabetes trials near Boston\",\n     \"BRCA1 breast cancer studies\",\n     \"open melanoma trials for adults\"\n   ];\n\n   export function SearchBar({ onSearch, isLoading }: SearchBarProps) {\n     const [query, setQuery] = useState('');\n     const [suggestions, setSuggestions] = useState<string[]>([]);\n     const [showSuggestions, setShowSuggestions] = useState(false);\n     const [placeholderIndex, setPlaceholderIndex] = useState(0);\n     const debounceRef = useRef<NodeJS.Timeout>();\n\n     // Cycle through example placeholders\n     useEffect(() => {\n       const interval = setInterval(() => {\n         setPlaceholderIndex((i) => (i + 1) % EXAMPLE_QUERIES.length);\n       }, 4000);\n       return () => clearInterval(interval);\n     }, []);\n\n     const handleInputChange = useCallback((value: string) => {\n       setQuery(value);\n       \n       // Debounce suggestions\n       if (debounceRef.current) clearTimeout(debounceRef.current);\n       debounceRef.current = setTimeout(async () => {\n         if (value.length >= 2) {\n           const results = await getSuggestions(value);\n           setSuggestions(results);\n           setShowSuggestions(results.length > 0);\n         } else {\n           setSuggestions([]);\n           setShowSuggestions(false);\n         }\n       }, 300);\n     }, []);\n\n     const handleSubmit = (e: React.FormEvent) => {\n       e.preventDefault();\n       if (query.trim()) {\n         onSearch(query.trim());\n         setShowSuggestions(false);\n       }\n     };\n\n     return (\n       <form onSubmit={handleSubmit} className=\"relative w-full max-w-3xl\">\n         <div className=\"relative\">\n           <input\n             type=\"text\"\n             value={query}\n             onChange={(e) => handleInputChange(e.target.value)}\n             placeholder={EXAMPLE_QUERIES[placeholderIndex]}\n             className=\"w-full px-6 py-4 text-lg rounded-xl border-2 border-teal-200\n                        focus:border-amber-400 focus:ring-4 focus:ring-amber-100\n                        placeholder:text-gray-400 placeholder:font-serif placeholder:italic\n                        transition-all duration-200\"\n           />\n           <button\n             type=\"submit\"\n             disabled={isLoading}\n             className=\"absolute right-2 top-1/2 -translate-y-1/2 px-6 py-2\n                        bg-teal-700 text-white rounded-lg hover:bg-teal-800\n                        disabled:opacity-50 transition-colors\"\n           >\n             {isLoading ? 'Searching...' : 'Search'}\n           </button>\n         </div>\n         \n         {/* Suggestions dropdown */}\n         {showSuggestions && (\n           <ul className=\"absolute z-10 w-full mt-2 bg-white rounded-lg shadow-lg\n                          border border-gray-200 animate-slideDown\">\n             {suggestions.map((s, i) => (\n               <li\n                 key={i}\n                 onClick={() => { setQuery(s); onSearch(s); setShowSuggestions(false); }}\n                 className=\"px-4 py-3 cursor-pointer hover:bg-teal-50\n                            border-b border-gray-100 last:border-0\"\n               >\n                 {s}\n               </li>\n             ))}\n           </ul>\n         )}\n       </form>\n     );\n   }\n   ```\n\n3. Create `frontend/src/components/QueryInterpretation.tsx`:\n   ```tsx\n   import type { ExtractedEntities } from '../types';\n\n   interface Props {\n     entities: ExtractedEntities;\n   }\n\n   const ENTITY_COLORS: Record<string, string> = {\n     phase: 'bg-indigo-100 text-indigo-800 border-indigo-200',\n     condition: 'bg-teal-100 text-teal-800 border-teal-200',\n     status: 'bg-emerald-100 text-emerald-800 border-emerald-200',\n     location: 'bg-slate-100 text-slate-800 border-slate-200',\n     keyword: 'bg-amber-100 text-amber-800 border-amber-200',\n     sponsor: 'bg-purple-100 text-purple-800 border-purple-200',\n     age_group: 'bg-rose-100 text-rose-800 border-rose-200',\n   };\n\n   export function QueryInterpretation({ entities }: Props) {\n     const chips: { label: string; value: string; type: string }[] = [];\n\n     if (entities.phase) chips.push({ label: 'Phase', value: entities.phase, type: 'phase' });\n     if (entities.condition) chips.push({ label: 'Condition', value: entities.condition, type: 'condition' });\n     if (entities.status) chips.push({ label: 'Status', value: entities.status.replace('_', ' '), type: 'status' });\n     if (entities.location) {\n       const loc = [entities.location.city, entities.location.state, entities.location.country]\n         .filter(Boolean).join(', ');\n       if (loc) chips.push({ label: 'Location', value: loc, type: 'location' });\n     }\n     if (entities.keyword) chips.push({ label: 'Keyword', value: entities.keyword, type: 'keyword' });\n     if (entities.sponsor) chips.push({ label: 'Sponsor', value: entities.sponsor, type: 'sponsor' });\n     if (entities.age_group) chips.push({ label: 'Age Group', value: entities.age_group, type: 'age_group' });\n\n     if (chips.length === 0) return null;\n\n     return (\n       <div className=\"w-full py-4 px-6 bg-gray-50 border-y border-gray-200\">\n         <span className=\"text-sm text-gray-500 mr-3\">We understood:</span>\n         <div className=\"inline-flex flex-wrap gap-2\">\n           {chips.map((chip, i) => (\n             <span\n               key={i}\n               className={`px-3 py-1 rounded-full text-sm font-medium border\n                          ${ENTITY_COLORS[chip.type]} animate-fadeIn`}\n               style={{ animationDelay: `${i * 100}ms` }}\n             >\n               <span className=\"font-semibold\">{chip.label}:</span> {chip.value}\n             </span>\n           ))}\n         </div>\n       </div>\n     );\n   }\n   ```\n\n4. Create `frontend/src/components/ResultCard.tsx`:\n   ```tsx\n   import { useState } from 'react';\n   import type { TrialResult } from '../types';\n\n   interface Props {\n     trial: TrialResult;\n     index: number;\n   }\n\n   const STATUS_COLORS: Record<string, string> = {\n     RECRUITING: 'bg-green-100 text-green-800 border-green-300',\n     NOT_YET_RECRUITING: 'bg-amber-100 text-amber-800 border-amber-300',\n     COMPLETED: 'bg-gray-100 text-gray-800 border-gray-300',\n     TERMINATED: 'bg-red-100 text-red-800 border-red-300',\n     ACTIVE_NOT_RECRUITING: 'bg-blue-100 text-blue-800 border-blue-300',\n   };\n\n   const STATUS_BORDER: Record<string, string> = {\n     RECRUITING: 'border-l-green-500',\n     NOT_YET_RECRUITING: 'border-l-amber-500',\n     COMPLETED: 'border-l-gray-400',\n     TERMINATED: 'border-l-red-500',\n     ACTIVE_NOT_RECRUITING: 'border-l-blue-500',\n   };\n\n   export function ResultCard({ trial, index }: Props) {\n     const [expanded, setExpanded] = useState(false);\n     const statusColor = STATUS_COLORS[trial.overall_status || ''] || STATUS_COLORS.COMPLETED;\n     const borderColor = STATUS_BORDER[trial.overall_status || ''] || 'border-l-gray-300';\n     const sponsor = trial.sponsors[0]?.name || 'Unknown';\n\n     return (\n       <div\n         className={`bg-white rounded-lg shadow-sm border border-gray-200 border-l-4\n                    ${borderColor} p-5 hover:shadow-md transition-shadow cursor-pointer\n                    animate-fadeIn`}\n         style={{ animationDelay: `${index * 50}ms` }}\n         onClick={() => setExpanded(!expanded)}\n       >\n         <div className=\"flex justify-between items-start gap-4\">\n           <div className=\"flex-1\">\n             <h3 className=\"font-serif text-lg font-semibold text-gray-900 leading-snug\">\n               {trial.brief_title}\n             </h3>\n             <p className=\"text-xs text-gray-400 font-mono mt-1\">{trial.nct_id}</p>\n           </div>\n           <span className={`px-2 py-1 text-xs rounded border ${statusColor} whitespace-nowrap`}>\n             {trial.overall_status?.replace(/_/g, ' ')}\n           </span>\n         </div>\n\n         <div className=\"mt-3 flex flex-wrap gap-4 text-sm text-gray-600\">\n           {trial.phase && <span>Phase: <strong>{trial.phase.replace('PHASE', '')}</strong></span>}\n           <span>Sponsor: <strong>{sponsor}</strong></span>\n           {trial.enrollment && <span>Enrollment: <strong>{trial.enrollment.toLocaleString()}</strong></span>}\n         </div>\n\n         {expanded && trial.brief_summaries_description && (\n           <div className=\"mt-4 pt-4 border-t border-gray-100\">\n             <p className=\"text-sm text-gray-600 leading-relaxed\">\n               {trial.brief_summaries_description}\n             </p>\n             {trial.facilities.length > 0 && (\n               <div className=\"mt-3\">\n                 <span className=\"text-xs font-semibold text-gray-500\">Locations: </span>\n                 <span className=\"text-xs text-gray-600\">\n                   {trial.facilities.map(f => [f.city, f.state, f.country].filter(Boolean).join(', ')).join(' | ')}\n                 </span>\n               </div>\n             )}\n           </div>\n         )}\n       </div>\n     );\n   }\n   ```",
        "testStrategy": "1. Test SearchBar debouncing - verify suggestions API called after 300ms delay\n2. Test placeholder cycling animation\n3. Test QueryInterpretation renders all entity types with correct colors\n4. Test ResultCard expansion toggle\n5. Test status color mapping for all status types\n6. Verify animations render smoothly\n7. Test mobile responsive behavior\n8. Test keyboard navigation in suggestions dropdown",
        "priority": "high",
        "dependencies": [
          2,
          7
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 9,
        "title": "Frontend Results List, Pagination, and State Management",
        "description": "Implement the ResultsList component with staggered animations, Pagination controls, ClarificationBanner for ambiguous queries, EmptyState for no results, and wire up the complete App component with state management.",
        "details": "1. Create `frontend/src/components/Pagination.tsx`:\n   ```tsx\n   interface Props {\n     currentPage: number;\n     totalPages: number;\n     onPageChange: (page: number) => void;\n   }\n\n   export function Pagination({ currentPage, totalPages, onPageChange }: Props) {\n     if (totalPages <= 1) return null;\n\n     const pages = Array.from({ length: Math.min(totalPages, 5) }, (_, i) => {\n       if (totalPages <= 5) return i + 1;\n       if (currentPage <= 3) return i + 1;\n       if (currentPage >= totalPages - 2) return totalPages - 4 + i;\n       return currentPage - 2 + i;\n     });\n\n     return (\n       <div className=\"flex items-center justify-center gap-2 mt-8\">\n         <button\n           onClick={() => onPageChange(currentPage - 1)}\n           disabled={currentPage === 1}\n           className=\"px-3 py-2 rounded-lg border border-gray-300 disabled:opacity-50\n                      hover:bg-gray-50 transition-colors\"\n         >\n           Previous\n         </button>\n         {pages.map((page) => (\n           <button\n             key={page}\n             onClick={() => onPageChange(page)}\n             className={`w-10 h-10 rounded-lg border transition-colors\n                        ${page === currentPage\n                          ? 'bg-teal-700 text-white border-teal-700'\n                          : 'border-gray-300 hover:bg-gray-50'}`}\n           >\n             {page}\n           </button>\n         ))}\n         <button\n           onClick={() => onPageChange(currentPage + 1)}\n           disabled={currentPage === totalPages}\n           className=\"px-3 py-2 rounded-lg border border-gray-300 disabled:opacity-50\n                      hover:bg-gray-50 transition-colors\"\n         >\n           Next\n         </button>\n       </div>\n     );\n   }\n   ```\n\n2. Create `frontend/src/components/ClarificationBanner.tsx`:\n   ```tsx\n   interface Props {\n     question: string;\n     onSelection: (choice: string) => void;\n   }\n\n   export function ClarificationBanner({ question, onSelection }: Props) {\n     // Extract potential options from the question (simplified)\n     const options = extractOptions(question);\n\n     return (\n       <div className=\"w-full py-4 px-6 bg-amber-50 border-y border-amber-200\n                       animate-slideDown\">\n         <p className=\"text-amber-800 font-medium mb-3\">{question}</p>\n         {options.length > 0 && (\n           <div className=\"flex flex-wrap gap-2\">\n             {options.map((opt, i) => (\n               <button\n                 key={i}\n                 onClick={() => onSelection(opt)}\n                 className=\"px-4 py-2 rounded-full bg-white border border-amber-300\n                            text-amber-800 hover:bg-amber-100 transition-colors\"\n               >\n                 {opt}\n               </button>\n             ))}\n           </div>\n         )}\n       </div>\n     );\n   }\n\n   function extractOptions(question: string): string[] {\n     // Simple extraction - could be enhanced\n     const matches = question.match(/'([^']+)'/g);\n     return matches ? matches.map(m => m.replace(/'/g, '')) : [];\n   }\n   ```\n\n3. Create `frontend/src/components/EmptyState.tsx`:\n   ```tsx\n   interface Props {\n     type: 'no-results' | 'error';\n     message?: string;\n     onRetry?: () => void;\n     onSuggestionClick?: (query: string) => void;\n   }\n\n   const SUGGESTED_QUERIES = [\n     \"Phase 3 cancer trials\",\n     \"Recruiting diabetes studies\",\n     \"COVID-19 vaccine trials\"\n   ];\n\n   export function EmptyState({ type, message, onRetry, onSuggestionClick }: Props) {\n     return (\n       <div className=\"flex flex-col items-center justify-center py-16 px-4\">\n         <div className=\"w-24 h-24 mb-6 rounded-full bg-gray-100 flex items-center justify-center\">\n           {type === 'no-results' ? (\n             <svg className=\"w-12 h-12 text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n               <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5}\n                     d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\" />\n             </svg>\n           ) : (\n             <svg className=\"w-12 h-12 text-red-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n               <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5}\n                     d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n             </svg>\n           )}\n         </div>\n         \n         <h2 className=\"font-serif text-2xl text-gray-700 mb-2\">\n           {type === 'no-results' ? 'No trials found' : 'Something went wrong'}\n         </h2>\n         <p className=\"text-gray-500 text-center max-w-md mb-6\">\n           {message || (type === 'no-results'\n             ? \"We couldn't find any clinical trials matching your search criteria.\"\n             : \"There was an error processing your request. Please try again.\")}\n         </p>\n\n         {type === 'error' && onRetry && (\n           <button\n             onClick={onRetry}\n             className=\"px-6 py-2 bg-teal-700 text-white rounded-lg hover:bg-teal-800\n                        transition-colors mb-6\"\n           >\n             Try Again\n           </button>\n         )}\n\n         {type === 'no-results' && onSuggestionClick && (\n           <div className=\"text-center\">\n             <p className=\"text-sm text-gray-500 mb-3\">Try one of these searches:</p>\n             <div className=\"flex flex-wrap justify-center gap-2\">\n               {SUGGESTED_QUERIES.map((q, i) => (\n                 <button\n                   key={i}\n                   onClick={() => onSuggestionClick(q)}\n                   className=\"px-4 py-2 rounded-full border border-teal-300 text-teal-700\n                              hover:bg-teal-50 transition-colors text-sm\"\n                 >\n                   {q}\n                 </button>\n               ))}\n             </div>\n           </div>\n         )}\n       </div>\n     );\n   }\n   ```\n\n4. Create `frontend/src/components/ResultsList.tsx`:\n   ```tsx\n   import type { TrialResult } from '../types';\n   import { ResultCard } from './ResultCard';\n   import { Pagination } from './Pagination';\n\n   interface Props {\n     results: TrialResult[];\n     total: number;\n     page: number;\n     pageSize: number;\n     onPageChange: (page: number) => void;\n   }\n\n   export function ResultsList({ results, total, page, pageSize, onPageChange }: Props) {\n     const totalPages = Math.ceil(total / pageSize);\n\n     return (\n       <div className=\"w-full max-w-4xl mx-auto\">\n         <p className=\"text-sm text-gray-500 mb-4\">\n           Showing {results.length} of {total.toLocaleString()} trials\n         </p>\n         <div className=\"space-y-4\">\n           {results.map((trial, index) => (\n             <ResultCard key={trial.nct_id} trial={trial} index={index} />\n           ))}\n         </div>\n         <Pagination\n           currentPage={page}\n           totalPages={totalPages}\n           onPageChange={onPageChange}\n         />\n       </div>\n     );\n   }\n   ```\n\n5. Update `frontend/src/App.tsx` with complete state management:\n   ```tsx\n   import { useState, useCallback } from 'react';\n   import { SearchBar } from './components/SearchBar';\n   import { QueryInterpretation } from './components/QueryInterpretation';\n   import { ResultsList } from './components/ResultsList';\n   import { ClarificationBanner } from './components/ClarificationBanner';\n   import { EmptyState } from './components/EmptyState';\n   import { searchTrials } from './services/api';\n   import type { SearchResponse } from './types';\n\n   type AppState = 'idle' | 'loading' | 'results' | 'no-results' | 'error';\n\n   export default function App() {\n     const [state, setState] = useState<AppState>('idle');\n     const [response, setResponse] = useState<SearchResponse | null>(null);\n     const [currentQuery, setCurrentQuery] = useState('');\n     const [error, setError] = useState<string | null>(null);\n\n     const handleSearch = useCallback(async (query: string, page = 1) => {\n       setCurrentQuery(query);\n       setState('loading');\n       setError(null);\n\n       try {\n         const result = await searchTrials(query, page);\n         setResponse(result);\n         setState(result.results.length > 0 ? 'results' : 'no-results');\n       } catch (err) {\n         setError(err instanceof Error ? err.message : 'Unknown error');\n         setState('error');\n       }\n     }, []);\n\n     const handlePageChange = useCallback((page: number) => {\n       handleSearch(currentQuery, page);\n       window.scrollTo({ top: 0, behavior: 'smooth' });\n     }, [currentQuery, handleSearch]);\n\n     const handleClarification = useCallback((choice: string) => {\n       handleSearch(`${currentQuery} ${choice}`);\n     }, [currentQuery, handleSearch]);\n\n     return (\n       <div className=\"min-h-screen bg-[#F8F6F3]\">\n         {/* Hero/Header section */}\n         <header className={`transition-all duration-300 ${state === 'idle' ? 'py-32' : 'py-8'}`}>\n           <div className=\"max-w-4xl mx-auto px-4 text-center\">\n             {state === 'idle' && (\n               <>\n                 <h1 className=\"font-serif text-5xl font-bold text-teal-900 mb-4\">\n                   Clinical Trials Search\n                 </h1>\n                 <p className=\"text-gray-600 text-lg mb-8\">\n                   Find clinical trials using natural language\n                 </p>\n               </>\n             )}\n             <SearchBar onSearch={handleSearch} isLoading={state === 'loading'} />\n           </div>\n         </header>\n\n         {/* Query interpretation */}\n         {response && state !== 'idle' && (\n           <QueryInterpretation entities={response.query_interpretation} />\n         )}\n\n         {/* Clarification banner */}\n         {response?.clarification && (\n           <ClarificationBanner\n             question={response.clarification}\n             onSelection={handleClarification}\n           />\n         )}\n\n         {/* Main content */}\n         <main className=\"px-4 py-8\">\n           {state === 'loading' && (\n             <div className=\"max-w-4xl mx-auto space-y-4\">\n               {[...Array(3)].map((_, i) => (\n                 <div key={i} className=\"h-32 bg-white rounded-lg animate-pulse\" />\n               ))}\n             </div>\n           )}\n\n           {state === 'results' && response && (\n             <ResultsList\n               results={response.results}\n               total={response.total}\n               page={response.page}\n               pageSize={response.page_size}\n               onPageChange={handlePageChange}\n             />\n           )}\n\n           {state === 'no-results' && (\n             <EmptyState\n               type=\"no-results\"\n               onSuggestionClick={handleSearch}\n             />\n           )}\n\n           {state === 'error' && (\n             <EmptyState\n               type=\"error\"\n               message={error || undefined}\n               onRetry={() => handleSearch(currentQuery)}\n             />\n           )}\n         </main>\n       </div>\n     );\n   }\n   ```",
        "testStrategy": "1. Test pagination navigation with multi-page results\n2. Test clarification banner rendering and selection\n3. Test empty state with suggestion clicks\n4. Test error state retry functionality\n5. Test loading skeleton display\n6. Test header transition from hero to compact\n7. Test smooth scroll on page change\n8. Test all state transitions: idle -> loading -> results/no-results/error\n9. Mobile responsive testing for all components",
        "priority": "high",
        "dependencies": [
          8
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 10,
        "title": "Visual Polish, Animations, and End-to-End Testing",
        "description": "Apply final visual polish including custom animations, font styling, responsive design refinements, and comprehensive end-to-end testing across diverse query types.",
        "details": "1. Update `frontend/src/index.css` with complete styling:\n   ```css\n   @import url('https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Outfit:wght@400;500;600&display=swap');\n   @import 'tailwindcss';\n\n   :root {\n     --color-primary: #0D4F4F;\n     --color-accent: #D4A843;\n     --color-bg: #F8F6F3;\n   }\n\n   body {\n     font-family: 'Outfit', sans-serif;\n     background-color: var(--color-bg);\n   }\n\n   .font-serif {\n     font-family: 'Fraunces', serif;\n   }\n\n   /* Custom animations */\n   @keyframes fadeIn {\n     from { opacity: 0; transform: translateY(8px); }\n     to { opacity: 1; transform: translateY(0); }\n   }\n\n   @keyframes slideDown {\n     from { opacity: 0; transform: translateY(-10px); }\n     to { opacity: 1; transform: translateY(0); }\n   }\n\n   @keyframes shimmer {\n     0% { background-position: -200% 0; }\n     100% { background-position: 200% 0; }\n   }\n\n   .animate-fadeIn {\n     animation: fadeIn 0.3s ease-out forwards;\n     opacity: 0;\n   }\n\n   .animate-slideDown {\n     animation: slideDown 0.2s ease-out forwards;\n   }\n\n   .animate-pulse {\n     background: linear-gradient(90deg, #e5e5e5 25%, #f5f5f5 50%, #e5e5e5 75%);\n     background-size: 200% 100%;\n     animation: shimmer 1.5s infinite;\n   }\n\n   /* Focus states */\n   input:focus {\n     box-shadow: 0 0 0 4px rgba(212, 168, 67, 0.2);\n   }\n\n   /* Scrollbar styling */\n   ::-webkit-scrollbar {\n     width: 8px;\n   }\n   ::-webkit-scrollbar-track {\n     background: #f1f1f1;\n   }\n   ::-webkit-scrollbar-thumb {\n     background: #c1c1c1;\n     border-radius: 4px;\n   }\n   ```\n\n2. Update `frontend/tailwind.config.ts`:\n   ```typescript\n   import type { Config } from 'tailwindcss'\n\n   export default {\n     content: ['./index.html', './src/**/*.{js,ts,jsx,tsx}'],\n     theme: {\n       extend: {\n         colors: {\n           teal: {\n             50: '#f0fdfa',\n             100: '#ccfbf1',\n             200: '#99f6e4',\n             300: '#5eead4',\n             400: '#2dd4bf',\n             500: '#14b8a6',\n             600: '#0d9488',\n             700: '#0D4F4F',\n             800: '#0A3D3D',\n             900: '#082f2f',\n           },\n           amber: {\n             400: '#D4A843',\n             500: '#c99a3a',\n           }\n         },\n         fontFamily: {\n           serif: ['Fraunces', 'serif'],\n           sans: ['Outfit', 'sans-serif'],\n         },\n       },\n     },\n     plugins: [],\n   } satisfies Config\n   ```\n\n3. Update `frontend/index.html` with proper meta tags:\n   ```html\n   <!DOCTYPE html>\n   <html lang=\"en\">\n     <head>\n       <meta charset=\"UTF-8\" />\n       <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n       <meta name=\"description\" content=\"Search clinical trials using natural language\" />\n       <title>Clinical Trials Search</title>\n       <link rel=\"preconnect\" href=\"https://fonts.googleapis.com\">\n       <link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" crossorigin>\n     </head>\n     <body>\n       <div id=\"root\"></div>\n       <script type=\"module\" src=\"/src/main.tsx\"></script>\n     </body>\n   </html>\n   ```\n\n4. End-to-end test scenarios to validate:\n   ```\n   Test Cases:\n   1. \"Phase 3 lung cancer trials in the USA\"\n      Expected: phase=PHASE3, condition=lung cancer, location.country=United States\n      Verify: Results show Phase 3 trials with lung cancer in title/description, US locations\n\n   2. \"recruiting diabetes trials near Boston\"\n      Expected: status=RECRUITING, condition=diabetes, location.city=Boston\n      Verify: All results have RECRUITING status, diabetes-related\n\n   3. \"List all Phase 2 trials for Breast Cancer associated with BRCA1 gene\"\n      Expected: phase=PHASE2, condition=Breast Cancer, keyword=BRCA1\n      Verify: Results mention BRCA1 in descriptions\n\n   4. \"open melanoma trials\" (synonym test)\n      Expected: status=RECRUITING (from \"open\" synonym), condition=melanoma\n      Verify: Synonym mapping works correctly\n\n   5. \"cancer\" (broad query - clarification test)\n      Expected: Low confidence, possibly clarification question\n      Verify: Clarification banner may appear or broad results returned\n\n   6. \"\" (empty query)\n      Expected: Error handling or prompt for input\n      Verify: Graceful handling without crash\n\n   7. \"asdfghjkl\" (gibberish)\n      Expected: No results or clarification\n      Verify: Empty state displayed with suggestions\n\n   8. Pagination test with broad query\n      Verify: Navigate between pages, results update correctly\n\n   9. Mobile responsive test\n      Verify: All components render correctly on mobile viewport\n   ```\n\n5. Performance optimizations:\n   - Verify debounce timing (300ms) provides good UX\n   - Test skeleton loading shows immediately\n   - Verify animations don't cause layout shift\n   - Check network waterfall for optimal loading",
        "testStrategy": "1. Execute all 9 end-to-end test scenarios documented above\n2. Record screenshots of each query result for verification\n3. Test on multiple browsers (Chrome, Firefox, Safari)\n4. Test responsive design at breakpoints: 320px, 768px, 1024px, 1440px\n5. Lighthouse audit for performance, accessibility, SEO\n6. Test with slow network throttling (3G simulation)\n7. Verify keyboard navigation works throughout app\n8. Test screen reader compatibility for accessibility\n9. Cross-browser animation rendering verification\n10. Final visual QA against design specifications",
        "priority": "medium",
        "dependencies": [
          9
        ],
        "status": "pending",
        "subtasks": []
      }
    ],
    "metadata": {
      "created": "2026-02-07T16:23:09.897Z",
      "updated": "2026-02-07T16:24:08.088Z",
      "description": "Tasks for master context"
    }
  }
}